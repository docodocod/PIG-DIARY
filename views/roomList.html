<head>
    <title>채팅목록</title>
    <link rel="stylesheet" href="/chatting.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
</head>
{% block content %}
<header>
    {% include "header.html" %}
</header>
<div id="content">
    <!-- 설정바(최소화, 닫기 버튼 등)
    <div class="setting_bar">
        <i class="icon-window-minimize" alt="최소화버튼" title="최소화"></i>
        <i class="icon-window-maximize" alt="최대화버튼" title="최대화"></i>
        <i class="icon-cancel" alt="닫기버튼" title="닫기"></i>
    </div>
    &lt;!&ndash; 헤더: 제목, 친구 찾기 버튼, 친구 추가 버튼 &ndash;&gt;
    <header>
        <h1>채팅방 목록</h1>
        <i class="icon-down-dir"></i>
        <span alt="새로운채팅버튼" title="새로운 채팅">&#xe80a</span>
        <span alt="오픈채팅버튼" title="오픈 채팅">&#xe809</span>
        <span alt="통합검색버튼" title="통합검색">&#xe801</span>
    </header>
    &lt;!&ndash; 친구창, 대화창, 설정창 등 이동 가능한 네비게이터 &ndash;&gt;
    <nav id="main-nav">
        <div class="main-menu">
            <a href="friend.html">
                <i class="icon-adult" alt="친구메뉴" title="친구"></i>
            </a>
            <a href="chatting.html">
                <i class="icon-chat" alt="채팅메뉴" title="채팅"></i>
                <span class="alert-balloon" alt="알림수">3</span>
            </a>
            <a href="more_menu.html">
                <i class="icon-ellipsis" alt="더보기버튼" title="더보기"></i>
                <span class="alert-balloon" alt="알림수">N</span>
            </a>
        </div>
        <div class="sub-menu">
            <a href="temp.html" target="_blank">
                <i class="icon-smile" alt="이모티콘샵바로가기" title="이모티콘샵"></i></a>
            <i class="icon-bell" alt="알림버튼" title="알림"></i>
            <i class="icon-cog" alt="설정버튼" title="설정"></i>
        </div>
    </nav>-->
    <!-- 메인: 채팅 리스트 화면 -->
    <div class="chat_list_main">
        <ul>
            {% for room in rooms %}
            <li data-id="{{room.id}}">
                <a href="/room/{{room.id}}">
                    <img src="./pic/k-pay.png" class="profile-img" alt="프로필 사진">
                    <div class="talk">
                        <p class="friend-name">{{room.opponent}}</p>
                        <p class="chat-content">{{room.Chat}}</p>
                    </div>
                    <div class="chat-status">
                        <time datetime="15:40:00+09:00">{{room.createdAt}}</time>
                        <span class="chat-balloon">??</sapn>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}
<footer>
    {% include "footer.html" %}
</footer>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io.connect('http://localhost:4161/room', { // 네임스페이스
        path: '/socket.io',
    });

    socket.on('newRoom', function (data) { // 새 방 이벤트 시 새 방 생성
        const li = document.createElement("li");
        li.setAttribute('data-id', data.room.id);

        const a = document.createElement('a');
        a.setAttribute('href', `/room/${data.room.id}`);

        const img = document.createElement('img');
        img.setAttribute('src');
        img.setAttribute('class', 'profile-img');
        img.setAttribute('alt', '프로필 사진');
        a.appendChild(img);

        const talkDiv = document.createElement('div');
        talkDiv.setAttribute('class', 'talk');

        const friendName = document.createElement('p');
        friendName.setAttribute('class', 'friend-name');
        friendName.textContent = data.room.opponent;
        talkDiv.appendChild(friendName);

        const chatContent= document.createElement('p');
        chatContent.setAttribute('class', 'chat-content');
        chatContent.textContent = '안녕하세요';
        talkDiv.appendChild(chatContent);

        a.appendChild(talkDiv);

        const chatStatusDiv = document.createElement('div');
        chatStatusDiv.setAttribute('class', 'chat-status');

        const timeElement = document.createElement('time');
        timeElement.setAttribute('datetime');
        timeElement.textContent = data.room.createdAt;
        chatStatusDiv.appendChild(timeElement);

        const chatBalloonSpan = document.createElement('span');
        chatBalloonSpan.setAttribute('class', 'chat-balloon');
        chatBalloonSpan.textContent = '??';
        chatStatusDiv.appendChild(chatBalloonSpan);
        a.appendChild(chatStatusDiv);
        li.appendChild(a);

        const chatList = document.getElementById('chat-list');
        chatList.appendChild(li);
    });

    socket.on('removeRoom', function (data) { // 방 제거 이벤트 시 id가 일치하는 방 제거
        document.querySelectorAll('li').forEach(function (li) {
            if (li.dataset.id === data) {
                li.parentNode.removeChild(li);
            }
        });
    });
</script>
{% block script %}
<script>
    window.onload = () => {
        if (new URL(location.href).searchParams.get('error')) {
            alert(new URL(location.href).searchParams.get('error'));
        }
    };
</script>
{% endblock %}